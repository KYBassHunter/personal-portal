<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title id="docTitle">Portal</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#0b1220; --text:#e5e7eb; --sub:#9ca3af;
    --brand:#60a5fa; --accent:#22d3ee; --border:#334155; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --radius:14px; --shadow:0 10px 24px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{display:flex;gap:12px;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:linear-gradient(0deg,transparent,rgba(0,0,0,.15)),var(--bg);backdrop-filter:saturate(140%) blur(4px);z-index:3}
  header h1{font-size:18px;margin:0;font-weight:600;letter-spacing:.2px}
  main{max-width:1200px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .profile{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;padding:16px}
  label{font-size:12px;color:var(--sub);display:block;margin-bottom:6px}
  input[type="text"], input[type="date"], input[type="time"], textarea{width:100%;background:var(--muted);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  .row{display:flex;gap:10px;align-items:end;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:var(--muted);font-size:12px;color:var(--sub)}
  .age-badge{font-weight:600;color:var(--text)}
  button{background:#1f2937;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer}
  button:hover{border-color:#4b5563}
  .tabs{margin-top:18px}
  .tablist{display:flex;gap:8px;flex-wrap:wrap;padding:8px}
  .tablist button{background:#0e162a;border-color:transparent}
  .tablist button[aria-selected="true"]{background:linear-gradient(180deg,#172036,#101725);border-color:#2b3b58}
  .add-tab{border-style:dashed}
  .tabpanel{display:none;padding:16px}
  .tabpanel[aria-hidden="false"]{display:block}
  .flex{display:flex;gap:12px;flex-wrap:wrap}
  .grow{flex:1 1 420px}
  .attachments{padding:12px;border:1px dashed #42526b;border-radius:12px;background:rgba(20,30,50,.35)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .list{width:100%;border-collapse:collapse;margin-top:10px}
  .list th,.list td{border-bottom:1px solid #223047;padding:8px 6px;font-size:13px;text-align:left}
  .list th{color:var(--sub);font-weight:600}
  .hint{font-size:12px;color:var(--sub)}
  .danger{color:var(--err)}
  .success{color:var(--ok)}
  .hidden{display:none}
  .dropzone{padding:16px;border:2px dashed #3b82f6;border-radius:12px;text-align:center;background:rgba(59,130,246,.08);transition:.15s}
  .dropzone.drag{background:rgba(59,130,246,.18)}
  .footer-tools{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1220;border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-size:12px}
  @media (max-width:720px){.profile{grid-template-columns:1fr}}

  /* Calendar */
  .cal-wrap{display:grid;grid-template-columns:1.3fr .7fr;gap:12px}
  @media (max-width:980px){.cal-wrap{grid-template-columns:1fr}}
  .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .cal-header h3{margin:0;font-size:16px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-cell{background:var(--muted);border:1px solid var(--border);border-radius:10px;min-height:86px;padding:8px;position:relative}
  .cal-cell .d{position:absolute;top:6px;right:8px;color:var(--sub);font-size:12px}
  .cal-cell .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--brand);margin-right:4px}
  .cal-weekday{color:var(--sub);font-size:12px;text-align:center;margin-bottom:6px}
  .cal-today{outline:2px solid var(--accent)}
  .cal-other{opacity:.4}
  .event-list{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--muted)}
  .event-item{border-bottom:1px solid #223047;padding:8px 0}
  .event-item:last-child{border-bottom:none}
  .small{font-size:12px;color:var(--sub)}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap}
  .section-head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px}
</style>
</head>
<body>
<header>
  <h1 id="headerTitle">Portal</h1>
  <span class="pill">Local storage: <span id="storageStatus">Initializing…</span></span>
</header>

<main>
  <!-- Profile -->
  <section class="card profile" id="profile">
    <div>
      <label for="name">Full name</label>
      <input id="name" type="text" placeholder="Enter full name" />
    </div>
    <div>
      <label for="dob">Date of birth</label>
      <input id="dob" type="date" />
    </div>
    <div>
      <label>Age</label>
      <div class="pill age-badge"><span id="age">—</span> years</div>
    </div>
    <div class="row">
      <button id="saveProfile">Save Profile</button>
      <button id="backupAll" title="Export all sections + files + events">Export Backup</button>
      <label class="kbd">
        Import Backup
        <input id="restoreBackup" type="file" accept=".json" class="hidden" />
      </label>
    </div>
  </section>

  <!-- Tabs -->
  <section class="tabs card" id="tabs">
    <nav class="tablist" role="tablist" aria-label="Sections">
      <!-- dynamically generated buttons go here -->
      <button role="tab" class="add-tab" id="btnAddSection" title="Add new section (+ attachments & notes)">+ Add Section</button>
      <button role="tab" aria-selected="false" aria-controls="panel-calendar" id="tab-calendar">Calendar</button>
    </nav>

    <!-- Weekday headings for calendar -->
    <div id="panel-calendar" class="tabpanel" role="tabpanel" aria-hidden="true">
      <div class="cal-wrap">
        <div>
          <div class="cal-header">
            <div class="btn-row">
              <button id="calPrev">&#9664; Prev</button>
              <button id="calToday">Today</button>
              <button id="calNext">Next &#9654;</button>
            </div>
            <h3 id="calTitle">Month YYYY</h3>
          </div>
          <div class="cal-grid" id="calWeekdays">
            <div class="cal-weekday">Sun</div><div class="cal-weekday">Mon</div><div class="cal-weekday">Tue</div>
            <div class="cal-weekday">Wed</div><div class="cal-weekday">Thu</div><div class="cal-weekday">Fri</div><div class="cal-weekday">Sat</div>
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>
        <div>
          <div class="row">
            <div style="flex:1">
              <label for="evDate">Date</label>
              <input id="evDate" type="date">
            </div>
            <div style="flex:.6">
              <label for="evStart">Start time</label>
              <input id="evStart" type="time">
            </div>
            <div style="flex:.6">
              <label for="evEnd">End time</label>
              <input id="evEnd" type="time">
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label for="evTitle">Title</label>
              <input id="evTitle" type="text" placeholder="Appointment / event">
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label for="evNotes">Notes</label>
              <textarea id="evNotes" rows="4" placeholder="Location, details, who with…"></textarea>
            </div>
          </div>
          <div class="btn-row">
            <button id="evSave" class="success">Save Event</button>
            <button id="evClear">Clear</button>
            <button id="evDelete" class="danger" disabled>Delete</button>
            <button id="evExportIcs">Export .ics</button>
          </div>
          <div class="btn-row" style="margin-top:8px">
            <button id="calExportMonth">Export Month .ics</button>
          </div>

          <div style="margin-top:12px">
            <label>Events on <span id="listDateLabel">—</span></label>
            <div class="event-list" id="eventList"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- dynamic section panels injected here -->
    <div id="dynamicPanels"></div>
  </section>
</main>

<script>
/* -------------------- Utilities -------------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const pad = n => (n<10?'0':'')+n;
const formatBytes = x => { const u=['B','KB','MB','GB']; let i=0, n=x||0; while(n>=1024&&i<u.length-1){n/=1024;i++;} return `${n.toFixed(n<10&&i?1:0)} ${u[i]}`; };

/* -------------------- IndexedDB -------------------- */
const DB_NAME='Portal_Generic';
const DB_VERSION=3; // includes 'sections' and 'events'
/*
  Stores:
  - profile { id:'profile', name, dob, savedOn }
  - sections { id, title, createdAt }     (list of user-defined sections)
  - notes   { keyPath: 'tab' }            (per section)
  - files   { keyPath: ['tab','id'], idx: tab } (per section)
  - events  { keyPath: 'id', idx: date }  (calendar)
*/
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME, DB_VERSION);
    req.onerror=()=>reject(req.error);
    req.onupgradeneeded=(e)=>{
      const db=req.result;
      if(!db.objectStoreNames.contains('profile')) db.createObjectStore('profile',{keyPath:'id'});
      if(!db.objectStoreNames.contains('sections')) db.createObjectStore('sections',{keyPath:'id'});
      if(!db.objectStoreNames.contains('notes')) db.createObjectStore('notes',{keyPath:'tab'});
      if(!db.objectStoreNames.contains('files')){
        const store=db.createObjectStore('files',{keyPath:['tab','id']}); store.createIndex('tab','tab',{unique:false});
      }
      if(!db.objectStoreNames.contains('events')){
        const ev=db.createObjectStore('events',{keyPath:'id'}); ev.createIndex('date','date',{unique:false});
      }
      // Seed default sections if first install
      if(e.oldVersion===0){
        const t=db.transaction(['sections'],'readwrite').objectStore('sections');
        t.put({id:crypto.randomUUID(), title:'Medical', createdAt:new Date().toISOString()});
        t.put({id:crypto.randomUUID(), title:'Employment', createdAt:new Date().toISOString()});
      }
    };
    req.onsuccess=()=>resolve(req.result);
  });
}
async function tx(names, mode='readonly'){ const db=await openDB(); return db.transaction(names, mode); }

/* Profile */
async function loadProfile(){ const t=await tx(['profile']); return new Promise(r=>{ const g=t.objectStore('profile').get('profile'); g.onsuccess=()=>r(g.result||null); g.onerror=()=>r(null); }); }
async function saveProfile(obj){ const t=await tx(['profile'],'readwrite'); return new Promise((r,j)=>{ const p=t.objectStore('profile').put({id:'profile',...obj}); p.onsuccess=()=>r(true); p.onerror=()=>j(p.error); }); }

/* Sections */
async function listSections(){ const t=await tx(['sections']); return new Promise(r=>{ const g=t.objectStore('sections').getAll(); g.onsuccess=()=>r((g.result||[]).sort((a,b)=>a.title.localeCompare(b.title))); g.onerror=()=>r([]); }); }
async function addSection(title){ const s={id:crypto.randomUUID(), title:title.trim(), createdAt:new Date().toISOString()}; const t=await tx(['sections'],'readwrite'); return new Promise(res=>{ t.objectStore('sections').put(s); t.oncomplete=()=>res(s); }); }
async function renameSection(id, title){ const t=await tx(['sections'],'readwrite'); const store=t.objectStore('sections'); return new Promise(res=>{ const g=store.get(id); g.onsuccess=()=>{ const val=g.result; if(!val) return res(false); val.title=title.trim(); store.put(val); t.oncomplete=()=>res(true); }; g.onerror=()=>res(false); }); }
async function removeSection(id, title){
  // delete section record + its notes + its files
  const t=await tx(['sections','notes','files'],'readwrite');
  const s=t.objectStore('sections'), n=t.objectStore('notes'), f=t.objectStore('files');
  s.delete(id); n.delete(title);
  const idx=f.index('tab'); const req=idx.getAllKeys(IDBKeyRange.only(title));
  return new Promise(res=>{
    req.onsuccess=()=>{ const keys=req.result||[]; keys.forEach(k=>f.delete(k)); t.oncomplete=()=>res(true); };
    req.onerror=()=>res(false);
  });
}

/* Notes */
async function getNotes(tab){ const t=await tx(['notes']); return new Promise(r=>{ const g=t.objectStore('notes').get(tab); g.onsuccess=()=>r(g.result?.text||''); g.onerror=()=>r(''); }); }
async function setNotes(tab,text){ const t=await tx(['notes'],'readwrite'); return new Promise((r)=>{ t.objectStore('notes').put({tab,text}); t.oncomplete=()=>r(true); }); }

/* Files */
async function addFiles(tab, fileList){ const t=await tx(['files'],'readwrite'); const store=t.objectStore('files'); const added=[]; for(const f of fileList){ const id=crypto.randomUUID(); const rec={ id, tab, name:f.name, type:f.type||'application/octet-stream', size:f.size, added:new Date().toISOString(), blob:f }; store.put(rec); added.push(rec); } return new Promise((r)=>{ t.oncomplete=()=>r(added); }); }
async function listFiles(tab){ const t=await tx(['files']); const idx=t.objectStore('files').index('tab'); return new Promise(r=>{ const q=idx.getAll(IDBKeyRange.only(tab)); q.onsuccess=()=>r(q.result||[]); q.onerror=()=>r([]); }); }
async function getFile(tab,id){ const t=await tx(['files']); return new Promise(r=>{ const g=t.objectStore('files').get([tab,id]); g.onsuccess=()=>r(g.result||null); g.onerror=()=>r(null); }); }
async function removeFile(tab,id){ const t=await tx(['files'],'readwrite'); return new Promise(r=>{ t.objectStore('files').delete([tab,id]); t.oncomplete=()=>r(true); }); }

/* Calendar */
async function evSave(rec){ const t=await tx(['events'],'readwrite'); return new Promise(r=>{ t.objectStore('events').put(rec); t.oncomplete=()=>r(true); }); }
async function evDelete(id){ const t=await tx(['events'],'readwrite'); return new Promise(r=>{ t.objectStore('events').delete(id); t.oncomplete=()=>r(true); }); }
async function evByDate(iso){ const t=await tx(['events']); const idx=t.objectStore('events').index('date'); return new Promise(r=>{ const q=idx.getAll(IDBKeyRange.only(iso)); q.onsuccess=()=>r(q.result||[]); q.onerror=()=>r([]); }); }
async function evByMonth(y,m){ const last=new Date(Date.UTC(y,m+1,0)).getUTCDate(); const map={}; for(let d=1; d<=last; d++){ const ds=`${y}-${pad(m+1)}-${pad(d)}`; map[ds]=await evByDate(ds); } return map; }

/* -------------------- UI + Behavior -------------------- */
const state = { sections:[], selectedPanel:null, cal:{view:new Date(), today:new Date(), selectedDate:null, editingId:null} };

function calcAge(iso){ if(!iso) return '—'; const dob=new Date(iso), now=new Date(); let y=now.getFullYear()-dob.getFullYear(); const m=now.getMonth()-dob.getMonth(); if(m<0||(m===0&&now.getDate()<dob.getDate())) y--; return y>=0?String(y):'—'; }

function setHeader(name){
  const title = name? `Portal — ${name}` : 'Portal';
  $('#headerTitle').textContent = title;
  $('#docTitle').textContent = title;
}

/* Build a section tab + panel */
function makeSectionPanel(title, id){
  const safeId = `section-${id}`;
  // Tab button
  const tabBtn = document.createElement('button');
  tabBtn.role='tab'; tabBtn.id=`tab-${safeId}`; tabBtn.textContent=title; tabBtn.dataset.sectionId=id; tabBtn.setAttribute('aria-selected','false');
  // Panel
  const panel = document.createElement('div');
  panel.id=`panel-${safeId}`; panel.className='tabpanel'; panel.setAttribute('role','tabpanel'); panel.setAttribute('aria-hidden','true');

  panel.innerHTML = `
    <div class="section-head">
      <div class="hint">Section: <strong>${title}</strong></div>
      <div class="btn-row">
        <button data-rename="${id}">Rename</button>
        <button data-remove="${id}" class="danger">Delete Section</button>
      </div>
    </div>
    <div class="flex">
      <div class="grow">
        <div class="attachments">
          <div class="dropzone" data-tab="${title}" id="drop-${safeId}">
            <strong>Drop files here</strong> or
            <label class="kbd">Choose files<input type="file" id="file-${safeId}" multiple class="hidden" /></label>
            <div class="hint">PDF, TIFF, JPG/PNG, DOC/X, XLS/X, TXT…</div>
          </div>
          <div class="actions">
            <button data-act="open" data-tab="${title}">Open</button>
            <button data-act="download" data-tab="${title}">Download</button>
            <button data-act="remove" data-tab="${title}" class="danger">Remove</button>
          </div>
          <table class="list" id="list-${safeId}">
            <thead><tr><th style="width:38px"></th><th>File</th><th>Type</th><th>Size</th><th>Added</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="grow">
        <label for="notes-${safeId}">${title} notes</label>
        <textarea id="notes-${safeId}" rows="10" placeholder="Enter notes for ${title}…"></textarea>
        <div class="footer-tools">
          <span class="hint">Notes are saved locally.</span>
          <button data-save-notes="${title}" class="success">Save Notes</button>
        </div>
      </div>
    </div>
  `;

  // Insert before Add button and ensure Calendar stays last
  const tablist = $('.tablist');
  const addBtn = $('#btnAddSection');
  tablist.insertBefore(tabBtn, addBtn);

  $('#dynamicPanels').appendChild(panel);

  // Wire per-section behaviors
  wireSection(title, id, safeId, tabBtn, panel);
}

/* Wire up a section’s inputs & actions */
function wireSection(title, id, safeId, tabBtn, panel){
  // Tab switching
  tabBtn.addEventListener('click', ()=>{
    $$('.tablist [role="tab"]').forEach(b=>b.setAttribute('aria-selected','false'));
    tabBtn.setAttribute('aria-selected','true');
    $$('.tabpanel').forEach(p=>p.setAttribute('aria-hidden','true'));
    panel.setAttribute('aria-hidden','false');
    state.selectedPanel = panel.id;
    refreshSection(title, safeId);
  });

  // File input
  const input = $(`#file-${safeId}`);
  input.addEventListener('change', async (e)=>{
    if(e.target.files?.length){ await addFiles(title, e.target.files); await refreshSection(title, safeId); e.target.value=''; }
  });

  // Dropzone
  const dz = $(`#drop-${safeId}`);
  const dragOn = ev => { ev.preventDefault(); dz.classList.add('drag'); };
  const dragOff = ev => { ev.preventDefault(); dz.classList.remove('drag'); };
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev, dragOn));
  ;['dragleave','drop'].forEach(ev=>dz.addEventListener(ev, dragOff));
  dz.addEventListener('drop', async ev=>{
    ev.preventDefault();
    const files=[...ev.dataTransfer.files];
    if(files.length){ await addFiles(title, files); await refreshSection(title, safeId); }
  });

  // Row selection
  $(`#list-${safeId}`).addEventListener('click', (e)=>{
    const tr=e.target.closest('tr'); if(!tr) return;
    tr.querySelector('input[type="radio"]').checked=true;
  });

  // Actions
  panel.querySelectorAll(`button[data-tab="${title}"]`).forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const tbody=$(`#list-${safeId}`); const sel=tbody.querySelector('input[type="radio"]:checked');
      if(btn.dataset.act!=='download' && !sel){ alert('Select a file first.'); return; }
      const tr=sel?.closest('tr'); const id=tr?.dataset.id;
      if(btn.dataset.act==='open'){
        const rec=await getFile(title,id); if(!rec){ alert('Missing file.'); return; }
        const url=URL.createObjectURL(rec.blob); window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url),60_000);
      }
      if(btn.dataset.act==='download'){
        if(!sel){ alert('Select a file first.'); return; }
        const rec=await getFile(title,id); if(!rec){ alert('Missing file.'); return; }
        const url=URL.createObjectURL(rec.blob); const a=document.createElement('a'); a.href=url; a.download=rec.name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),60_000);
      }
      if(btn.dataset.act==='remove'){
        if(confirm('Remove the selected attachment?')){ await removeFile(title,id); await refreshSection(title, safeId); }
      }
    });
  });

  // Notes
  panel.querySelector(`[data-save-notes="${title}"]`).addEventListener('click', async ()=>{
    const text = $(`#notes-${safeId}`).value || '';
    await setNotes(title, text); flashStatus(`Saved notes for ${title}`, 'ok');
  });

  // Rename / Delete section
  panel.querySelector(`[data-rename="${id}"]`).addEventListener('click', async ()=>{
    const newTitle = prompt('Rename section to:', title); if(!newTitle) return;
    const trimmed = newTitle.trim(); if(!trimmed){ alert('Name cannot be empty.'); return; }
    // Prevent duplicates
    const exists = state.sections.some(s=>s.title.toLowerCase()===trimmed.toLowerCase());
    if(exists && trimmed.toLowerCase()!==title.toLowerCase()){ alert('A section with that name already exists.'); return; }
    await renameSection(id, trimmed);
    // Rebuild UI (simplest approach)
    await rebuildSections();
  });

  panel.querySelector(`[data-remove="${id}"]`).addEventListener('click', async ()=>{
    if(!confirm(`Delete section "${title}"? This removes its notes and files locally.`)) return;
    await removeSection(id, title);
    await rebuildSections();
  });
}

async function refreshSection(title, safeId){
  // files
  const rows = await listFiles(title);
  const tbody = $(`#list-${safeId} tbody`); tbody.innerHTML='';
  for(const r of rows.sort((a,b)=>a.name.localeCompare(b.name))){
    const tr=document.createElement('tr'); tr.dataset.id=r.id;
    tr.innerHTML = `
      <td><input type="radio" name="sel-${safeId}" /></td>
      <td title="${r.name}">${r.name}</td>
      <td>${r.type||'—'}</td>
      <td>${formatBytes(r.size)}</td>
      <td>${new Date(r.added).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  }
  // notes
  $(`#notes-${safeId}`).value = await getNotes(title);
}

async function rebuildSections(){
  // Clear existing UI tabs (except Add + Calendar) and panels
  $$('.tablist [role="tab"]').forEach(b=>{
    if(b.id!=='btnAddSection' && b.id!=='tab-calendar') b.remove();
  });
  $('#dynamicPanels').innerHTML='';
  state.sections = await listSections();
  for(const s of state.sections){ makeSectionPanel(s.title, s.id); }
  // Select first section by default (or keep current)
  const firstTab = $$('.tablist [role="tab"]')
    .find(b=>b.id!=='btnAddSection' && b.id!=='tab-calendar');
  if(firstTab){ firstTab.click(); }
}

/* Status flash */
function flashStatus(msg, kind='ok'){
  const el = $('#storageStatus'); el.textContent=msg;
  el.style.color = kind==='ok' ? 'var(--ok)' : kind==='warn' ? 'var(--warn)' : 'var(--err)';
  setTimeout(()=>{ el.textContent='Ready'; el.style.color=''; }, 2000);
}

/* Tabs: Calendar wire */
(function wireCalendarTab(){
  const calBtn = $('#tab-calendar');
  calBtn.addEventListener('click', ()=>{
    $$('.tablist [role="tab"]').forEach(b=>b.setAttribute('aria-selected','false'));
    calBtn.setAttribute('aria-selected','true');
    $$('.tabpanel').forEach(p=>p.setAttribute('aria-hidden','true'));
    $('#panel-calendar').setAttribute('aria-hidden','false');
    renderCalendar();
  });
})();

/* Add Section button */
$('#btnAddSection').addEventListener('click', async ()=>{
  const name = prompt('New section name (e.g., Insurance, Education, Housing):');
  if(!name) return;
  const trimmed = name.trim(); if(!trimmed){ alert('Name cannot be empty.'); return; }
  const exists = state.sections.some(s=>s.title.toLowerCase()===trimmed.toLowerCase());
  if(exists){ alert('A section with that name already exists.'); return; }
  const s = await addSection(trimmed);
  await rebuildSections();
  // auto-open the new tab
  const tab = $(`#tab-section-${s.id}`); if(tab) tab.click();
});

/* Calendar rendering and ICS */
function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function renderCalHeader(){ const m=state.cal.view.getMonth(), y=state.cal.view.getFullYear(); $('#calTitle').textContent=new Date(y,m,1).toLocaleString(undefined,{month:'long',year:'numeric'}); }
async function renderCalGrid(){
  const grid=$('#calGrid'); grid.innerHTML='';
  const y=state.cal.view.getFullYear(), m=state.cal.view.getMonth();
  const first=new Date(y,m,1); const start=(first.getDay()+7)%7; const daysInMonth=new Date(y,m+1,0).getDate(); const prevDays=new Date(y,m,0).getDate();
  const map=await evByMonth(y,m);
  for(let i=0;i<42;i++){
    const cell=document.createElement('div'); cell.className='cal-cell';
    let dayNum,date,other=false;
    if(i<start){ dayNum=prevDays-start+i+1; date=new Date(y,m-1,dayNum); other=true; }
    else if(i>=start+daysInMonth){ dayNum=i-(start+daysInMonth)+1; date=new Date(y,m+1,dayNum); other=true; }
    else { dayNum=i-start+1; date=new Date(y,m,dayNum); }
    const iso=ymd(date); const isToday=iso===ymd(state.cal.today);
    const dots=(map[iso]||[]).slice(0,4).map(()=>'<span class="dot"></span>').join('');
    cell.innerHTML=`<div class="d">${dayNum}</div><div>${dots}</div>`;
    if(other) cell.classList.add('cal-other'); if(isToday) cell.classList.add('cal-today');
    cell.addEventListener('click',()=>selectDate(iso)); grid.appendChild(cell);
  }
}
async function renderCalendar(){ renderCalHeader(); await renderCalGrid(); const m=state.cal.view.getMonth(), y=state.cal.view.getFullYear(); const todayInView=(state.cal.today.getMonth()===m&&state.cal.today.getFullYear()===y)?ymd(state.cal.today):`${y}-${pad(m+1)}-01`; await selectDate(state.cal.selectedDate||todayInView); }
async function selectDate(iso){ state.cal.selectedDate=iso; $('#evDate').value=iso; $('#listDateLabel').textContent=new Date(iso).toLocaleDateString(); $('#evTitle').value=''; $('#evStart').value=''; $('#evEnd').value=''; $('#evNotes').value=''; state.cal.editingId=null; $('#evDelete').disabled=true; renderEventList(await evByDate(iso)); }
function renderEventList(list){
  const box=$('#eventList'); box.innerHTML=''; if(!list.length){ box.innerHTML='<div class="small">No events.</div>'; return; }
  for(const ev of list.sort((a,b)=>(a.start||'').localeCompare(b.start||''))){
    const wrap=document.createElement('div'); wrap.className='event-item';
    wrap.innerHTML=`<div><strong>${ev.title||'(Untitled)'}</strong></div>
      <div class="small">${ev.start||'—'}–${ev.end||'—'}</div>
      <div class="small">${ev.notes?ev.notes:''}</div>
      <div class="btn-row" style="margin-top:6px">
        <button data-ev="edit" data-id="${ev.id}">Edit</button>
        <button data-ev="ics" data-id="${ev.id}">Export .ics</button>
        <button data-ev="del" data-id="${ev.id}" class="danger">Delete</button>
      </div>`;
    box.appendChild(wrap);
  }
  box.querySelectorAll('button[data-ev]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id=btn.dataset.id;
      if(btn.dataset.ev==='edit'){
        const t=await tx(['events']); const p=new Promise(res=>{ const r=t.objectStore('events').get(id); r.onsuccess=()=>res(r.result); r.onerror=()=>res(null); }); const ev=await p; if(!ev) return;
        $('#evDate').value=ev.date; $('#evStart').value=ev.start||''; $('#evEnd').value=ev.end||''; $('#evTitle').value=ev.title||''; $('#evNotes').value=ev.notes||''; state.cal.editingId=id; $('#evDelete').disabled=false;
      }
      if(btn.dataset.ev==='del'){ if(confirm('Delete this event?')){ await evDelete(id); await selectDate(state.cal.selectedDate); await renderCalGrid(); } }
      if(btn.dataset.ev==='ics'){ const t=await tx(['events']); const p=new Promise(res=>{ const r=t.objectStore('events').get(id); r.onsuccess=()=>res(r.result); r.onerror=()=>res(null); }); const ev=await p; if(ev) downloadICS([ev], `Event-${ev.date}.ics`); }
    });
  });
}

/* Calendar controls */
$('#calPrev').addEventListener('click',()=>{ state.cal.view=new Date(state.cal.view.getFullYear(), state.cal.view.getMonth()-1, 1); renderCalendar(); });
$('#calNext').addEventListener('click',()=>{ state.cal.view=new Date(state.cal.view.getFullYear(), state.cal.view.getMonth()+1, 1); renderCalendar(); });
$('#calToday').addEventListener('click',()=>{ state.cal.view=new Date(); state.cal.view.setDate(1); renderCalendar(); });
$('#evSave').addEventListener('click', async ()=>{
  const rec={ id: state.cal.editingId || crypto.randomUUID(), date: $('#evDate').value, start: $('#evStart').value||'', end: $('#evEnd').value||'', title: ($('#evTitle').value||'').trim(), notes: ($('#evNotes').value||'').trim() };
  if(!rec.title){ alert('Please enter a title'); return; }
  await evSave(rec); flashStatus('Event saved','ok'); state.cal.editingId=null; $('#evDelete').disabled=true; await selectDate(rec.date); await renderCalGrid();
});
$('#evClear').addEventListener('click',()=>{ $('#evTitle').value=''; $('#evStart').value=''; $('#evEnd').value=''; $('#evNotes').value=''; state.cal.editingId=null; $('#evDelete').disabled=true; });
$('#evDelete').addEventListener('click', async ()=>{ if(!state.cal.editingId) return; if(confirm('Delete this event?')){ await evDelete(state.cal.editingId); state.cal.editingId=null; $('#evDelete').disabled=true; await selectDate(state.cal.selectedDate); await renderCalGrid(); } });
$('#evExportIcs').addEventListener('click',()=>{ const ev={ id:crypto.randomUUID(), date: $('#evDate').value, start: $('#evStart').value||'', end: $('#evEnd').value||'', title:($('#evTitle').value||'').trim()||'Untitled', notes:($('#evNotes').value||'').trim() }; downloadICS([ev], `Event-${ev.date}.ics`); });
$('#calExportMonth').addEventListener('click', async ()=>{
  const y=state.cal.view.getFullYear(), m=state.cal.view.getMonth(); const map=await evByMonth(y,m); const events=Object.values(map).flat(); if(!events.length){ alert('No events in this month.'); return; } downloadICS(events, `Events-${y}-${pad(m+1)}.ics`);
});

/* ICS helpers */
function toICSDate(dateIso,time=''){ const d=new Date(dateIso+(time?`T${time}:00`:'T00:00:00')); const y=d.getFullYear(), m=pad(d.getMonth()+1), dd=pad(d.getDate()), hh=pad(d.getHours()), mm=pad(d.getMinutes()), ss='00'; return `${y}${m}${dd}T${hh}${mm}${ss}`; }
function escapeICS(t=''){ return t.replace(/\\/g,'\\\\').replace(/;/g,'\\;').replace(/,/g,'\\,').replace(/\n/g,'\\n'); }
function buildICS(events){ const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Portal Generic//Calendar//EN']; for(const ev of events){ const uid=ev.id||crypto.randomUUID(); const dtStart=toICSDate(ev.date, ev.start||'00:00'); const dtEnd=toICSDate(ev.date, ev.end||ev.start||'01:00'); lines.push('BEGIN:VEVENT',`UID:${uid}`,`DTSTAMP:${toICSDate(new Date().toISOString().slice(0,10),'00:00')}`,`DTSTART:${dtStart}`,`DTEND:${dtEnd}`,`SUMMARY:${escapeICS(ev.title||'Untitled')}`,ev.notes?`DESCRIPTION:${escapeICS(ev.notes)}`:'','END:VEVENT'); } lines.push('END:VCALENDAR'); return lines.filter(Boolean).join('\r\n'); }
function downloadICS(events, filename){ const blob=new Blob([buildICS(events)],{type:'text/calendar'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),60_000); }

/* Backup/Restore (includes sections, files, events, notes, profile) */
async function exportBackup(){
  const out={ meta:{ exportedAt:new Date().toISOString(), app:'Portal Generic v3' }, profile:await loadProfile(), sections:await listSections(), notes:{}, files:{}, events:[] };
  for(const s of out.sections){ out.notes[s.title]=await getNotes(s.title); const list=await listFiles(s.title); out.files[s.title]=await Promise.all(list.map(async f=>{ const ab=await f.blob.arrayBuffer(); const b64=btoa(String.fromCharCode(...new Uint8Array(ab))); return { id:f.id,name:f.name,type:f.type,size:f.size,added:f.added, blob_b64:b64 }; })); }
  const t=await tx(['events']); const p=new Promise(res=>{ const r=t.objectStore('events').getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>res([]); }); out.events=await p;
  const blob=new Blob([JSON.stringify(out)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`PortalBackup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),60_000); flashStatus('Backup exported');
}
async function restoreBackup(e){
  const file=e.target.files?.[0]; if(!file) return;
  try{
    const text=await file.text(); const data=JSON.parse(text); if(!data) throw new Error('Invalid backup');
    if(Array.isArray(data.sections)){ // replace sections (simple approach)
      // Clear existing sections first
      const cur=await listSections(); for(const s of cur){ await removeSection(s.id, s.title); }
      // Re-add
      for(const s of data.sections){ await addSection(s.title); }
    }
    if(data.profile){ await saveProfile(data.profile); }
    if(data.notes){ for(const [tab,txt] of Object.entries(data.notes)){ await setNotes(tab, txt); } }
    if(data.files){ for(const [tab,list] of Object.entries(data.files)){ for(const rec of list){ const bytes=Uint8Array.from(atob(rec.blob_b64||''), c=>c.charCodeAt(0)); const blob=new Blob([bytes.buffer],{type:rec.type||'application/octet-stream'}); await addFiles(tab, [new File([blob], rec.name, {type: blob.type})]); } } }
    if(Array.isArray(data.events)){ for(const ev of data.events){ await evSave({ id: ev.id||crypto.randomUUID(), date: ev.date, start: ev.start||'', end: ev.end||'', title: ev.title||'', notes: ev.notes||'' }); } }
    flashStatus('Backup restored','ok'); await rebuildSections(); renderCalendar(); initProfileUI();
  }catch(err){ console.error(err); flashStatus('Restore failed','err'); alert('Could not restore backup: '+(err?.message||err)); }
  finally{ e.target.value=''; }
}

/* Profile UI */
async function initProfileUI(){
  const p=await loadProfile();
  if(p?.name) $('#name').value=p.name; else $('#name').value='';
  if(p?.dob)  $('#dob').value=p.dob;  else $('#dob').value='';
  $('#age').textContent = calcAge($('#dob').value);
  setHeader($('#name').value.trim());
}

/* Init */
(async function init(){
  try{ await openDB(); $('#storageStatus').textContent='Ready'; }catch{ $('#storageStatus').textContent='Unavailable'; alert('Browser storage blocked. Enable cookies/storage.'); }
  await rebuildSections(); // builds default: Medical, Employment
  // Default select first section
  const firstTab = $$('.tablist [role="tab"]').find(b=>b.id!=='btnAddSection' && b.id!=='tab-calendar');
  if(firstTab) firstTab.click();

  // Profile events
  await initProfileUI();
  $('#dob').addEventListener('change', ()=>{ $('#age').textContent = calcAge($('#dob').value); });
  const saveProfileBtn = $('#saveProfile');
  saveProfileBtn.addEventListener('click', async ()=>{
    const obj={ name: $('#name').value.trim()||'', dob: $('#dob').value||null, savedOn:new Date().toISOString() };
    await saveProfile(obj); $('#age').textContent=calcAge(obj.dob); setHeader(obj.name); flashStatus('Profile saved','ok');
  });
  // Update header live when name changes (without saving)
  $('#name').addEventListener('input', (e)=> setHeader(e.target.value.trim()));

  // Backup/Restore
  $('#backupAll').addEventListener('click', exportBackup);
  $('#restoreBackup').parentElement.addEventListener('click', ()=>$('#restoreBackup').click());
  $('#restoreBackup').addEventListener('change', restoreBackup);

  // Calendar initial state
  state.cal.view = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
})();
</script>
</body>
</html>
